# SLURM
Slurm Cluster configuration with one Master node and one Worker node

ON MASTER NODE
==============

apt update
apt  upgrade -y
export MUNGEUSER=1001
sudo useradd -m -c "MUNGE Uid 'N' Gid Emporium" -d /var/lib/munge -u $MUNGEUSER -g munge -s /sbin/nologin munge 
export SLURMUSER=1002 
sudo useradd -m -c "SLURM workload manager" -d /var/lib/slurm -u $SLURMUSER -g slurm -s /bin/bash slurm
sudo apt-get install -y munge
sudo chown -R munge: /etc/munge/ /var/log/munge/ /var/lib/munge/ /run/munge/
sudo chmod 0700 /etc/munge/ /var/log/munge/ /var/lib/munge/ /run/munge/
chown -R munge:munge /run/munge
chmod 0700 /run/munge
sudo systemctl enable munge
sudo systemctl start munge
sudo apt-get install build-essential fakeroot devscripts libmunge-dev libmunge2 munge
sudo apt upgrade
mkdir slurm
cd slurm
wget https://download.schedmd.com/slurm/slurm-23.11.8.tar.bz2
tar -xaf slurm-23.11.8.tar.bz2
cd slurm-23.11.8/
sudo apt install libswitch-perl equivs mk-build-deps
sudo apt install equivs
sudo mk-build-deps -i debian/control
debuild -b -uc -us
cd ..
sudo dpkg -i slurm-*.deb
sudo mkdir -p /etc/slurm
nano slurm.conf
nano cgroup.conf

<slurm.conf template below>
----------------------------

# slurm.conf file generated by configurator.html.
# Put this file on all nodes of your cluster.
# See the slurm.conf man page for more information.
#
ClusterName=YOUR_NODE_NAME
SlurmctldHost=localhost
MpiDefault=none
ReturnToService=2
SlurmctldPidFile=/var/run/slurmctld.pid
SlurmctldPort=6817
SlurmdPidFile=/var/run/slurmd.pid
SlurmdPort=6818
SlurmdSpoolDir=/var/lib/slurm/slurmd
SlurmUser=slurm
StateSaveLocation=/var/lib/slurm/slurmctld
SwitchType=switch/none
#
# TIMERS
InactiveLimit=0
KillWait=30
MinJobAge=300
SlurmctldTimeout=120
SlurmdTimeout=300
Waittime=0
# SCHEDULING - The scheduler Parameters entry correctly instructs mpi how to bind cores
SchedulerType=sched/backfill
SelectType=select/cons_tres
SchedulerParameters=default_cpu_bind=cores
#
#MEMORY LIMITING - These settings make sure SLURM controls the job core affinities
ProctrackType=proctrack/cgroup
TaskPlugin=task/cgroup,task/affinity
SelectTypeParameters=CR_CPU_Memory
#
#AccountingStoragePort=
AccountingStorageType=accounting_storage/none
JobCompType=jobcomp/none
JobAcctGatherFrequency=30
JobAcctGatherType=jobacct_gather/none
SlurmctldDebug=info
SlurmctldLogFile=/var/log/slurm/slurmctld.log
SlurmdDebug=info
SlurmdLogFile=/var/log/slurm/slurmd.log
#
# COMPUTE NODES - CUSTOMIZE SOCKETS, CORESPERSOCKET, CPUS AND REALMEMORY BASED ON YOUR MACHINE SPECS
NodeName=localhost Sockets=2 CoresPerSocket=128 CPUs=256 RealMemory=1500000 State=UNKNOWN
PartitionName=batch Nodes=ALL Default=YES MaxTime=INFINITE State=UP

-----------------------------------------------------------------------------------------------------

< cgroup.conf Template below >
--------------------------------

# cgroup.conf file
CgroupAutomount=yes
CgroupMountpoint=/sys/fs/cgroup
ConstrainCores=yes
ConstrainRAMSpace=yes
ConstrainSwapSpace=yes
ConstrainDevices=no

---------------------------------

sudo cp slurm.conf /etc/slurm/
sudo cp cgroup.conf /etc/slurm/
mkdir /var/spool/slurmctld
chown slurm:slurm /var/spool/slurmctld
chmod 755 /var/spool/slurmctld
mkdir  /var/log/slurm
touch /var/log/slurm/slurmctld.log
touch /var/log/slurm/slurm_jobacct.log /var/log/slurm/slurm_jobcomp.log
chown -R slurm:slurm /var/log/slurm/
chmod 755 /var/log/slurm
sudo chown -R slurm:slurm /var/spool/slurmctld
sudo chown -R slurm:slurm /var/spool/slurmd
sudo chown -R slurm:slurm /var/log/slurm
sudo chown -R slurm:slurm /var/lib/slurm
sudo chmod -R 755 /var/spool/slurmctld
sudo chmod -R 755 /var/spool/slurmd
sudo chmod -R 755 /var/log/slurm
sudo chmod -R 755 /var/lib/slurm

systemctl daemon-reload
systemctl enable slurmctld
systemctl start slurmctld

=============\\\\\\\\\=========\\\\\\\\==============\\\\\\\\\==================

On Worker Node
==============
apt update
apt upgrade -y
export MUNGEUSER=1001 
sudo groupadd -g $MUNGEUSER munge 
sudo useradd -m -c "MUNGE Uid 'N' Gid Emporium" -d /var/lib/munge -u $MUNGEUSER -g munge -s /sbin/nologin munge 
export SLURMUSER=1002
sudo groupadd -g $SLURMUSER slurm
sudo useradd -m -c "SLURM workload manager" -d /var/lib/slurm -u $SLURMUSER -g slurm -s /bin/bash slurm
sudo apt-get install -y munge





